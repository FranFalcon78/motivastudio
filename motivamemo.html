<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MemoDance Web — Agenda de práctica</title>
<style>
  :root{
    --bg:#050712;
    --panel:#111528;
    --panel-soft:#151a33;
    --accent:#c94055;
    --accent-soft:rgba(201,64,85,0.35);
    --border:rgba(255,255,255,0.18);
    --text:#f4f6ff;
    --muted:#aab1d2;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:radial-gradient(circle at top,#1a2144 0,#050712 52%,#020309 100%);color:var(--text);overflow:hidden}
  body::before{
    content:"";
    position:fixed;
    inset:-40px;
    background:
      radial-gradient(circle at 10% 0%,rgba(255,255,255,0.12),transparent 55%),
      radial-gradient(circle at 90% 10%,rgba(201,64,85,0.35),transparent 55%),
      radial-gradient(circle at 50% 90%,rgba(42,110,255,0.35),transparent 55%);
    filter:blur(40px);
    opacity:.5;
    z-index:-1;
  }
  .brand{
    position:fixed;
    top:10px;
    left:14px;
    font-size:12px;
    padding:4px 10px;
    border-radius:999px;
    background:rgba(0,0,0,0.45);
    color:#fff;
    border:1px solid rgba(255,255,255,0.18);
    letter-spacing:.03em;
    z-index:20;
    user-select:none;
  }
  .layout{
    height:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:70px 16px 24px;
  }
  .card{
    width:min(1100px,100%);
    height:100%;
    max-height:620px;
    background:rgba(7,10,25,0.88);
    border-radius:24px;
    border:1px solid var(--border);
    box-shadow:0 18px 45px rgba(0,0,0,0.65);
    backdrop-filter:blur(16px);
    padding:20px 22px 16px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .card-header{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:16px;
  }
  .card-title{
    font-size:20px;
    font-weight:600;
  }
  .subtitle{
    font-size:13px;
    color:var(--muted);
    margin-top:2px;
    max-width:560px;
  }
  .badge-today{
    font-size:13px;
    padding:4px 10px;
    border-radius:999px;
    background:rgba(0,0,0,0.45);
    border:1px solid rgba(255,255,255,0.18);
    color:var(--muted);
  }
  .badge-today b{color:var(--text);font-weight:500}
  .add-form{
    display:grid;
    grid-template-columns: minmax(0,2.2fr) 90px minmax(0,2.3fr) auto;
    gap:8px 10px;
    align-items:center;
    margin-top:6px;
  }
  .field-label{
    font-size:12px;
    color:var(--muted);
  }
  .field-input{
    width:100%;
    padding:7px 9px;
    border-radius:10px;
    border:1px solid rgba(255,255,255,0.16);
    background:rgba(6,8,20,0.85);
    color:var(--text);
    font-size:13px;
    outline:none;
  }
  .field-input:focus{
    border-color:var(--accent);
    box-shadow:0 0 0 1px rgba(201,64,85,0.55);
  }
  select.field-input{
    padding-right:24px;
    background-image:linear-gradient(45deg,transparent 50%,var(--muted) 50%),linear-gradient(135deg,var(--muted) 50%,transparent 50%);
    background-position:calc(100% - 14px) 9px,calc(100% - 9px) 9px;
    background-size:5px 5px;
    background-repeat:no-repeat;
  }
  .btn-primary{
    padding:7px 16px;
    border-radius:12px;
    border:none;
    background:linear-gradient(135deg,var(--accent),#ff7a7a);
    color:#fff;
    font-size:13px;
    font-weight:500;
    cursor:pointer;
    white-space:nowrap;
    box-shadow:0 8px 18px rgba(201,64,85,0.55);
    transition:transform .12s ease,box-shadow .12s ease,filter .12s ease;
  }
  .btn-primary:hover{
    transform:translateY(-1px);
    filter:brightness(1.04);
    box-shadow:0 10px 22px rgba(201,64,85,0.7);
  }
  .btn-primary:active{
    transform:translateY(0);
    box-shadow:0 6px 14px rgba(201,64,85,0.5);
  }
  .rules{
    font-size:11px;
    color:var(--muted);
    margin-top:4px;
  }
  .status{
    font-size:13px;
    margin-top:6px;
    color:#d0d6ff;
  }
  .table-wrapper{
    margin-top:6px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,0.12);
    background:radial-gradient(circle at top left,rgba(255,255,255,0.04),transparent 55%);
    overflow:hidden;
    flex:1 1 auto;
    min-height:160px;
  }
  table{
    width:100%;
    border-collapse:collapse;
    font-size:13px;
  }
  thead{
    background:rgba(7,10,25,0.95);
  }
  th,td{
    padding:6px 8px;
    border-bottom:1px solid rgba(255,255,255,0.04);
  }
  th{
    text-align:left;
    font-weight:500;
    color:var(--muted);
    font-size:12px;
  }
  td.center,th.center{text-align:center}
  tbody tr:nth-child(even){
    background:rgba(5,8,22,0.72);
  }
  tbody tr:nth-child(odd){
    background:rgba(6,9,24,0.92);
  }
  tbody tr.row-priority{
    background:rgba(201,64,85,0.13);
  }
  tbody tr.row-priority td{
    border-bottom-color:rgba(201,64,85,0.4);
  }
  tbody tr.row-priority td:nth-child(3){
    color:#ffb4c0;
    font-weight:600;
  }
  .actions{
    white-space:nowrap;
    text-align:right;
  }
  .btn-mini{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    margin-left:4px;
    padding:3px 7px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,0.25);
    background:rgba(9,12,30,0.9);
    color:var(--text);
    font-size:11px;
    cursor:pointer;
    min-width:0;
  }
  .btn-mini:hover{
    background:rgba(201,64,85,0.9);
    border-color:rgba(255,255,255,0.45);
  }
  .btn-mini-danger{
    border-color:rgba(255,120,120,0.8);
    color:#ffd6d6;
  }
  .btn-mini-danger:hover{
    background:rgba(255,80,80,0.9);
  }
  .footer-actions{
    margin-top:6px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    font-size:12px;
  }
  .btn-ghost{
    border-radius:999px;
    border:1px solid rgba(255,255,255,0.28);
    background:transparent;
    padding:5px 12px;
    color:var(--text);
    font-size:12px;
    cursor:pointer;
  }
  .btn-ghost:hover{
    background:rgba(255,255,255,0.08);
  }
  .link-soft{
    color:var(--muted);
    text-decoration:none;
  }
  .link-soft span{
    color:var(--accent);
  }
  .link-soft:hover{
    color:var(--text);
  }
  @media (max-width:820px){
    .card{
      padding:16px 14px 12px;
      max-height:none;
    }
    .layout{
      padding-top:60px;
    }
    .add-form{
      grid-template-columns: minmax(0,1.6fr) 80px minmax(0,1.8fr);
      grid-template-rows:auto auto;
    }
    .add-form .btn-primary{
      grid-column:1 / -1;
      justify-self:flex-end;
      margin-top:2px;
    }
    .footer-actions{
      flex-direction:column;
      align-items:flex-start;
    }
    .actions{
      white-space:normal;
    }
  }
</style>
</head>
<body>
<div class="brand">MemoDance Web — by Fran Falcón</div>
<div class="layout">
  <div class="card">
    <div class="card-header">
      <div>
        <div class="card-title">Agenda de práctica por niveles</div>
        <p class="subtitle">
          Registra tus figuras y vídeos de baile, organiza tu práctica con niveles 1–6 y abre cada vínculo en CursoPlayerWeb cuando llegue el día.
        </p>
      </div>
      <div class="badge-today" id="todayBadge"></div>
    </div>

    <form id="addForm" class="add-form">
      <div>
        <div class="field-label">Vídeo / Figura</div>
        <input id="nameInput" class="field-input" type="text" placeholder="Nombre corto de la figura o rutina">
      </div>
      <div>
        <div class="field-label">Nivel</div>
        <select id="levelInput" class="field-input">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
        </select>
      </div>
      <div>
        <div class="field-label">Vínculo (ruta local o URL)</div>
        <input id="linkInput" class="field-input" type="text" placeholder="C:\videos\figura1.mp4 o https://...">
      </div>
      <div>
        <div class="field-label">&nbsp;</div>
        <button type="submit" class="btn-primary">Añadir a la agenda</button>
      </div>
    </form>

    <div class="rules">
      Reglas de repetición: L1 a diario · L2 días del mes múltiplos de 3 · L3 múltiplos de 5 · L4 días 10/20/30 · L5 día 30 · L6 día 31.<br>
      Lo no practicado se arrastra como <b>PRIORIDAD</b> al día siguiente.
    </div>

    <div class="status" id="statusLabel"></div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Vídeo / Figura</th>
            <th class="center">Nivel</th>
            <th class="center">Estado</th>
            <th class="center">Próx. cita</th>
            <th>Notas</th>
            <th class="center">Acciones</th>
          </tr>
        </thead>
        <tbody id="agendaBody">
        </tbody>
      </table>
    </div>

    <div class="footer-actions">
      <div>
        <button type="button" id="viewAllBtn" class="btn-ghost">Ver todos los vídeos y figuras</button>
      </div>
      <div>
        <a class="link-soft" href="https://franfalcon78.github.io/cursoplayerweb/" target="_blank" rel="noopener">
          Abrir <span>CursoPlayerWeb</span> en otra pestaña
        </a>
      </div>
    </div>
  </div>
</div>

<script src="memodance_core.js"></script>
<script>
(function(){
  function escapeHtml(str){
    return (str || '').replace(/[&<>"']/g, function(c){
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c] || c;
    });
  }

  const state = window.MemoDance.loadState();
  const tbody = document.getElementById('agendaBody');
  const statusEl = document.getElementById('statusLabel');
  const todayBadge = document.getElementById('todayBadge');
  const addForm = document.getElementById('addForm');
  const nameInput = document.getElementById('nameInput');
  const levelInput = document.getElementById('levelInput');
  const linkInput = document.getElementById('linkInput');

  const today = new Date();
  const todayLocale = today.toLocaleDateString('es-ES', { weekday:'long', day:'2-digit', month:'long', year:'numeric' });
  todayBadge.innerHTML = 'Hoy<br><b>' + escapeHtml(todayLocale) + '</b>';

  function refreshAgenda(){
    const now = new Date();
    window.MemoDance.computePriorityFlags(state, now);
    window.MemoDance.saveState(state);

    tbody.innerHTML = '';
    const due = window.MemoDance.itemsDueToday(state, now);

    if(due.length === 0){
      statusEl.textContent = 'Hoy no hay pendientes en tu agenda. Puedes repasar libremente o añadir nuevas figuras.';
    }else{
      statusEl.textContent = 'Pendientes para hoy: ' + due.length + ' figura(s). Marca como hecho después de practicar.';
    }

    const baseDate = new Date(now.getTime());
    baseDate.setHours(0,0,0,0);

    due.forEach(function(it){
      const tr = document.createElement('tr');
      tr.dataset.id = String(it.id);
      if(it.priority){
        tr.classList.add('row-priority');
      }

      const next = window.MemoDance.nextDueDate(it.level, baseDate);
      const statusText = it.priority ? 'PRIORIDAD' : 'Debido hoy';

      tr.innerHTML =
        '<td>' + escapeHtml(it.name || '') + '</td>' +
        '<td class="center">' + (it.level || 1) + '</td>' +
        '<td class="center">' + statusText + '</td>' +
        '<td class="center">' + escapeHtml(window.MemoDance.formatDateISO(next) || '') + '</td>' +
        '<td>' + escapeHtml(it.notes || '') + '</td>' +
        '<td class="actions">' +
          '<button type="button" class="btn-mini" data-act="open">Abrir</button>' +
          '<button type="button" class="btn-mini" data-act="done">Hecho</button>' +
          '<button type="button" class="btn-mini" data-act="level">Nivel</button>' +
          '<button type="button" class="btn-mini" data-act="notes">Notas</button>' +
          '<button type="button" class="btn-mini" data-act="link">Vínculo</button>' +
          '<button type="button" class="btn-mini btn-mini-danger" data-act="delete">✕</button>' +
        '</td>';

      tbody.appendChild(tr);
    });
  }

  addForm.addEventListener('submit', function(ev){
    ev.preventDefault();
    const name = nameInput.value.trim();
    const level = levelInput.value;
    const link = linkInput.value.trim();

    if(!name && !link){
      alert('Escribe el nombre de la figura o un vínculo (ruta local o URL).');
      return;
    }
    const finalName = name || (link.split(/[\/\\\\]/).pop() || 'Vídeo sin título');
    window.MemoDance.addItem(state, finalName, level, link, '');
    nameInput.value = '';
    linkInput.value = '';
    refreshAgenda();
  });

  document.getElementById('viewAllBtn').addEventListener('click', function(){
    window.location.href = 'registro_memodance.html';
  });

  tbody.addEventListener('click', function(ev){
    const btn = ev.target.closest('button[data-act]');
    if(!btn) return;
    const tr = btn.closest('tr');
    if(!tr) return;
    const id = tr.dataset.id;
    const item = state.items.find(function(it){ return String(it.id) === String(id); });
    if(!item) return;

    const act = btn.dataset.act;
    if(act === 'open'){
      openInCursoPlayer(item);
    }else if(act === 'done'){
      window.MemoDance.markDoneToday(state, id);
      refreshAgenda();
    }else if(act === 'level'){
      const current = item.level || 1;
      const input = prompt('Nuevo nivel (1-6):', current);
      if(input === null) return;
      const n = parseInt(input, 10);
      if(!(n >= 1 && n <= 6)){
        alert('Nivel no válido. Debe estar entre 1 y 6.');
        return;
      }
      window.MemoDance.changeLevel(state, id, n);
      refreshAgenda();
    }else if(act === 'notes'){
      const input = prompt('Notas para esta figura:', item.notes || '');
      if(input === null) return;
      window.MemoDance.editNotes(state, id, input);
      refreshAgenda();
    }else if(act === 'link'){
      const input = prompt('Vínculo (ruta local o URL):', item.link || '');
      if(input === null) return;
      window.MemoDance.editLink(state, id, input);
      refreshAgenda();
    }else if(act === 'delete'){
      if(confirm('¿Eliminar esta figura de forma permanente?')){
        window.MemoDance.deleteItem(state, id);
        refreshAgenda();
      }
    }
  });

  function openInCursoPlayer(item){
    const link = (item.link || '').trim();
    if(!link){
      alert('Esta figura no tiene vínculo configurado. Usa "Vínculo" para añadir una ruta local o una URL.');
      return;
    }
    try{
      localStorage.setItem('cursoplayer_last_link', link);
    }catch(e){}

    const base = 'https://franfalcon78.github.io/cursoplayerweb/';
    if(/^https?:/i.test(link)){
      window.open(base + '?src=' + encodeURIComponent(link), '_blank');
    }else{
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(link).catch(function(){});
      }
      window.open(base, '_blank');
      alert(
        'He guardado este vínculo como "último vídeo" en el navegador.\n' +
        'Por seguridad el navegador no puede abrir archivos locales automáticamente.\n' +
        'Abre CursoPlayerWeb y selecciona manualmente el archivo correspondiente.'
      );
    }
  }

  refreshAgenda();
})();
</script>
</body>
</html>