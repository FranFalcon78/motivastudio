<!DOCTYPE html>
<!-- saved from url=(0038)file:///home/fran/Descargas/index.html -->
<html lang="es"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CursoPlayer Web ‚Äî by Fran Falc√≥n</title>
<style>
  :root{
    --bg:#0f0f10; --panel:#191a1c; --panel-2:#222428; --text:#e8e8ea;
    --muted:#a5a7ad; --accent:#79c7ff; --danger:#ff6b6b; --ok:#78e08f;
    --warn:#ffd76b; --rail:#2d2f34; --rail-fill:#5b5f67; --rail-ab:#ff4757aa;
    --btn:#2a2d33; --btn-h:#343840; --btn-t:#eaeaea;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Noto Sans", "Helvetica Neue", Arial}
  .app{display:grid;grid-template-rows:auto 1fr auto;gap:.5rem;height:100%;padding:.5rem}
  .topbar{display:grid;grid-auto-flow:column;grid-auto-columns:max-content;gap:.35rem;align-items:center;background:var(--panel);border:1px solid #2a2d33;padding:.4rem .5rem;border-radius:12px;overflow:auto}
  button{appearance:none;border:0;background:var(--btn);color:var(--btn-t);padding:.55rem .7rem;border-radius:10px;cursor:pointer;transition:.12s;white-space:nowrap}
  button:hover{background:var(--btn-h)}
  button[disabled]{opacity:.6;cursor:not-allowed}
  .ghost{background:transparent;border:1px solid #2a2d33}
  .grow{min-width:0}
  .spacer{width:.35rem}
  #file{display:none}
  .video-wrap{position:relative;background:black;border-radius:14px;border:1px solid #2a2d33;overflow:hidden}
  video{width:100%;height:100%;display:block;background:black}
  .mirror{transform:scaleX(-1)}
  .overlay{position:absolute;inset:0;pointer-events:none}
  .bottom{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:.6rem;background:var(--panel);border:1px solid #2a2d33;padding:.5rem;border-radius:12px}
  .tc{color:var(--muted);font-variant-numeric:tabular-nums}
  /* timeline */
  .tl{position:relative;height:28px;user-select:none}
  .tl-rail{position:absolute;left:0;right:0;top:50%;height:10px;transform:translateY(-50%);background:var(--rail);border-radius:999px;outline:1px solid #2a2d33}
  .tl-fill{position:absolute;left:0;top:50%;height:10px;transform:translateY(-50%);background:var(--rail-fill);border-radius:999px}
  .tl-ab{position:absolute;top:50%;height:14px;transform:translateY(-50%);background:var(--rail-ab);border-radius:8px}
  .tl-knob{position:absolute;top:50%;width:14px;height:14px;border-radius:50%;transform:translate(-50%,-50%);background:#ddd;outline:1px solid #222}
  .tl-mark{position:absolute;top:50%;width:2px;height:18px;transform:translate(-50%,-50%);background:#ff6b6b}
  .tl-hit{position:absolute;inset:0;cursor:pointer}
  .labels{display:flex;gap:.75rem;color:var(--muted)}
  .modal{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;padding:1rem}
  .modal.active{display:flex}
  .card{background:var(--panel-2);border:1px solid #2a2d33;max-width:min(720px,90vw);border-radius:14px;padding:1rem}
  .card h3{margin:.2rem 0 .6rem}
  .row{display:flex;gap:.4rem;flex-wrap:wrap}
  .hint{color:var(--muted);font-size:.9rem}
  .tag{padding:.1rem .45rem;border:1px solid #3a3f47;border-radius:999px;color:#bfc3ca}
  @media (max-width:720px){
    .topbar{grid-auto-flow:row;grid-template-columns:repeat(3, minmax(0,1fr))}
    .topbar button{width:100%}
    .bottom{grid-template-columns:auto 1fr;grid-auto-rows:auto}
  }
</style>
</head>
<body>
<div class="app" id="app">
  <div class="topbar" role="toolbar" aria-label="Controles de CursoPlayer">
    <input id="file" type="file" accept="video/*">
    <button id="openBtn">üìÇ Abrir</button>
    <button id="playBtn">‚è∏ Pausa</button>
    <button id="mirrorBtn">Espejo: OFF</button>
    <button id="infoBtn" class="ghost">‚Ñπ Info</button>
    <button id="fsBtn" class="ghost">Pantalla completa</button>
    <div class="spacer"></div>
    <button id="rateDown">Vel-</button>
    <button id="rateUp">Vel+</button>
    <button id="rateReset">Vel 1.00x</button>
    <div class="spacer"></div>
    <button id="markA">Marca A ‚úì</button>
    <button id="markB">Marca B ‚úì</button>
    <button id="clearAB" class="ghost">Desmarcar A‚ÄëB</button>
    <button id="cutAB" title="Recorta el segmento A‚ÄëB y descarga">‚úÇ Recortar A‚ÄëB</button>
    <button id="loopBtn">Bucle A‚ÄëB: OFF</button>
  </div>

  <div class="video-wrap" id="vw">
    <video id="vid" preload="metadata" playsinline="" src="blob:null/0b742cb6-5439-47f2-ba24-14a6966def14"></video>
    <div class="overlay"></div>
  </div>

  <div class="bottom">
    <div class="labels">
      <span class="tc" id="tcA">A: 00:00:48.867</span>
      <span class="tc" id="tcB">B: 00:01:25.822</span>
    </div>
    <div class="tl" id="timeline" aria-label="L√≠nea de tiempo">
      <div class="tl-rail"></div>
      <div class="tl-fill" style="width: 79.5909%;"></div>
      <div class="tl-ab" style="display: block; left: 26.9964%; right: 52.5877%;"></div>
      <div class="tl-mark" id="markAline" style="display: block; left: 26.9964%;"></div>
      <div class="tl-mark" id="markBline" style="display: block; left: 47.4123%;"></div>
      <div class="tl-knob" style="left: 79.5909%;"></div>
      <div class="tl-hit" title="Arrastra para navegar"></div>
    </div>
    <div class="tc"><span id="tcNow">00:02:24.069</span> / <span id="tcDur">00:03:01.012</span></div>
  </div>
</div>

<!-- Modal Info -->
<div class="modal" id="infoModal" role="dialog" aria-modal="true">
  <div class="card">
    <h3>Informaci√≥n del clip</h3>
    <div id="infoText" class="hint"></div>
    <div class="row" style="margin-top:.8rem">
      <button id="closeInfo" class="ghost">Cerrar</button>
    </div>
  </div>
</div>

<!-- Toast simple -->
<div id="toast" style="position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%); background: rgba(34, 34, 34, 0.667); backdrop-filter: blur(6px); color: rgb(255, 255, 255); padding: 0.6rem 0.9rem; border-radius: 10px; display: none;">Error al recortar (ver consola)</div>

<script type="module">
  // Utilidades
  const $ = sel => document.querySelector(sel);
  const clamp = (v,a,b)=>Math.min(b,Math.max(a,v));
  const fmtTC = (sec)=>{
    if(!Number.isFinite(sec)||sec<0) sec=0;
    const ms = Math.round((sec%1)*1000);
    const s  = Math.floor(sec)%60;
    const m  = Math.floor(sec/60)%60;
    const h  = Math.floor(sec/3600);
    const z = n=>String(n).padStart(2,'0');
    return `${z(h)}:${z(m)}:${z(s)}.${String(ms).padStart(3,'0')}`;
  };
  const toast=(msg,ms=1600)=>{const t=$("#toast");t.textContent=msg;t.style.display="block";clearTimeout(t._id);t._id=setTimeout(()=>t.style.display="none",ms)};

  // Estado
  const vid = $("#vid");
  let fileHandle = null;           // File del usuario para ffmpeg.wasm
  let pointA = null, pointB = null;
  let loopAB = false;
  let dragging = null;             // 'seek' | 'A' | 'B'
  let userRate = 1.0;
  let ffmpeg = null;
  let ffmpegReady = false;

  // Controles
  const btnOpen = $("#openBtn");
  const fileInp = $("#file");
  const btnPlay = $("#playBtn");
  const btnMirror = $("#mirrorBtn");
  const btnInfo = $("#infoBtn");
  const btnFS = $("#fsBtn");
  const btnRateDn = $("#rateDown");
  const btnRateUp = $("#rateUp");
  const btnRateReset = $("#rateReset");
  const btnA = $("#markA");
  const btnB = $("#markB");
  const btnClear = $("#clearAB");
  const btnCut = $("#cutAB");
  const btnLoop = $("#loopBtn");
  const tl = $("#timeline");
  const tlFill = tl.querySelector(".tl-fill");
  const tlKnob = tl.querySelector(".tl-knob");
  const tlAB = tl.querySelector(".tl-ab");
  const tlHit = tl.querySelector(".tl-hit");
  const markAline = $("#markAline");
  const markBline = $("#markBline");
  const tcA = $("#tcA"), tcB = $("#tcB"), tcNow = $("#tcNow"), tcDur = $("#tcDur");

  // Abrir archivo (input y drag&drop)
  btnOpen.addEventListener("click",()=>fileInp.click());
  fileInp.addEventListener("change",e=>{
    const f = e.target.files?.[0];
    if(f) loadFile(f);
  });
  const vw = $("#vw");
  ["dragenter","dragover"].forEach(ev=>vw.addEventListener(ev,e=>{e.preventDefault();e.dataTransfer.dropEffect="copy";vw.style.outline="2px dashed #4c9eff"}));
  ["dragleave","drop"].forEach(ev=>vw.addEventListener(ev, e=>{e.preventDefault();vw.style.outline="none"}));
  vw.addEventListener("drop", e=>{
    const f = [...e.dataTransfer.files].find(f=>f.type.startsWith("video/")) || e.dataTransfer.files[0];
    if(f) loadFile(f);
  });

  async function loadFile(file){
    fileHandle = file;
    const url = URL.createObjectURL(file);
    vid.src = url;
    await vid.play().catch(()=>{});
    btnPlay.textContent = "‚è∏ Pausa";
    resetAB();
    userRate = 1.0; applyRate();
    toast("Archivo cargado: " + (file.name || "video"));
  }

  // Reproducir / pausa
  btnPlay.addEventListener("click",()=>{
    if(vid.paused){vid.play();btnPlay.textContent="‚è∏ Pausa";}
    else {vid.pause();btnPlay.textContent="‚ñ∂ Reproducir";}
  });

  // Info
  const modal = $("#infoModal"), infoText=$("#infoText");
  btnInfo.addEventListener("click",()=>{
    const dur = Number.isFinite(vid.duration) ? fmtTC(vid.duration) : "--:--:--.---";
    const name = fileHandle?.name || "(sin archivo)";
    infoText.innerHTML = `
      <div><strong>Fichero:</strong> ${name}</div>
      <div><strong>Duraci√≥n:</strong> ${dur}</div>
      <div><strong>Reproductor:</strong> HTML5 Video</div>
      <div style="margin-top:.4rem" class="hint">
        <span class="tag">Espacio = Reproducir/Pausa</span>
        <span class="tag">F11 = Pantalla completa</span>
        <span class="tag">‚Üê/‚Üí = ¬±10%</span>
        <span class="tag">‚Üë/‚Üì = ¬±10s</span>
        <span class="tag">Rueda = ¬±2s</span>
      </div>`;
    modal.classList.add("active");
  });
  $("#closeInfo").addEventListener("click",()=>modal.classList.remove("active"));
  modal.addEventListener("click",e=>{ if(e.target===modal) modal.classList.remove("active") });

  // Fullscreen
  btnFS.addEventListener("click",()=>toggleFS());
  function toggleFS(){
    const el = document.documentElement;
    if(!document.fullscreenElement){ el.requestFullscreen?.(); btnFS.textContent="Salir pantalla completa"; }
    else { document.exitFullscreen?.(); btnFS.textContent="Pantalla completa"; }
  }
  document.addEventListener("fullscreenchange",()=>{
    btnFS.textContent = document.fullscreenElement? "Salir pantalla completa" : "Pantalla completa";
  });

  // Mirror
  btnMirror.addEventListener("click",()=>{
    vid.classList.toggle("mirror");
    btnMirror.textContent = "Espejo: " + (vid.classList.contains("mirror") ? "ON" : "OFF");
  });

  // Velocidad
  function applyRate(){ vid.playbackRate = userRate; btnRateReset.textContent = `Vel ${userRate.toFixed(2)}x`; }
  btnRateDn.addEventListener("click",()=>{ userRate = clamp((userRate-0.1),0.10,3.0); applyRate() });
  btnRateUp.addEventListener("click",()=>{ userRate = clamp((userRate+0.1),0.10,3.0); applyRate() });
  btnRateReset.addEventListener("click",()=>{ userRate = 1.0; applyRate() });

  // Marcas A/B
  function resetAB(){
    pointA = pointB = null; loopAB=false;
    btnLoop.textContent = "Bucle A‚ÄëB: OFF";
    tcA.textContent = "A: --:--:--.---";
    tcB.textContent = "B: --:--:--.---";
    $("#markA").textContent = "Marca A";
    $("#markB").textContent = "Marca B";
    tlAB.style.display="none"; markAline.style.display="none"; markBline.style.display="none";
  }
  btnClear.addEventListener("click", resetAB);
  btnLoop.addEventListener("click",()=>{
    loopAB=!loopAB;
    btnLoop.textContent = "Bucle A‚ÄëB: " + (loopAB? "ON":"OFF");
  });
  btnA.addEventListener("click",()=>{
    if(pointA!=null){ pointA=null; tcA.textContent="A: --:--:--.---"; btnA.textContent="Marca A"; }
    else { pointA=vid.currentTime; tcA.textContent="A: "+fmtTC(pointA); btnA.textContent="Marca A ‚úì"; }
    drawTL();
  });
  btnB.addEventListener("click",()=>{
    if(pointB!=null){ pointB=null; tcB.textContent="B: --:--:--.---"; btnB.textContent="Marca B"; }
    else { pointB=vid.currentTime; tcB.textContent="B: "+fmtTC(pointB); btnB.textContent="Marca B ‚úì"; }
    drawTL();
  });
  const abValid = ()=> pointA!=null && pointB!=null && pointB>pointA;

  // L√≠nea de tiempo
  function ratioFromX(x){
    const rect = tl.getBoundingClientRect();
    return clamp((x-rect.left)/rect.width,0,1);
  }
  function xFromRatio(r){
    const rect = tl.getBoundingClientRect();
    return rect.left + rect.width * clamp(r,0,1);
  }
  function drawTL(){
    const dur = Number.isFinite(vid.duration)? vid.duration : 0;
    const rNow = dur? (vid.currentTime/dur): 0;
    tlKnob.style.left = `${rNow*100}%`;
    tlFill.style.width = `${rNow*100}%`;
    tcNow.textContent = fmtTC(vid.currentTime||0);
    tcDur.textContent = fmtTC(dur||0);
    // A/B visuals
    if(pointA!=null){
      const rA = clamp(pointA/dur,0,1);
      markAline.style.left = `${rA*100}%`; markAline.style.display="block";
    } else markAline.style.display="none";
    if(pointB!=null){
      const rB = clamp(pointB/dur,0,1);
      markBline.style.left = `${rB*100}%`; markBline.style.display="block";
    } else markBline.style.display="none";
    if(abValid()){
      const rA = clamp(pointA/dur,0,1), rB = clamp(pointB/dur,0,1);
      const left = Math.min(rA,rB)*100, right = Math.max(rA,rB)*100;
      tlAB.style.display="block"; tlAB.style.left = left+"%"; tlAB.style.right = (100-right)+"%";
    } else tlAB.style.display="none";
  }
  vid.addEventListener("timeupdate", drawTL);
  vid.addEventListener("durationchange", drawTL);
  vid.addEventListener("loadedmetadata", drawTL);

  // Bucle A‚ÄëB
  vid.addEventListener("timeupdate", ()=>{
    if(loopAB && abValid()){
      if(vid.currentTime < pointA) vid.currentTime = pointA;
      if(vid.currentTime >= pointB) vid.currentTime = pointA;
    }
  });
  // Cuando termina y no hay A‚ÄëB, reinicia (bucle global como en escritorio)
  vid.addEventListener("ended", ()=>{
    if(loopAB && abValid()) { vid.currentTime = pointA; vid.play(); }
    else { vid.currentTime = 0; vid.play(); }
  });

  // Interacci√≥n timeline: click/drag seek + arrastre de marcas
  function whichHit(e){
    const rect = tl.getBoundingClientRect();
    const x = e.clientX;
    const near = (px)=>Math.abs(px-x)<=8;
    const dur = Number.isFinite(vid.duration)? vid.duration : 0;
    const rA = pointA!=null? (pointA/dur): null;
    const rB = pointB!=null? (pointB/dur): null;
    const xA = rA!=null? (rect.left + rect.width*rA): null;
    const xB = rB!=null? (rect.left + rect.width*rB): null;
    if(xA!=null && near(xA)) return "A";
    if(xB!=null && near(xB)) return "B";
    return "seek";
  }
  function setTimeFromClientX(clientX){
    const r = ratioFromX(clientX);
    const dur = Number.isFinite(vid.duration)? vid.duration : 0;
    let t = r*dur;
    if(loopAB && abValid()){
      t = clamp(t, pointA, pointB);
    }
    vid.currentTime = t;
    drawTL();
  }
  tlHit.addEventListener("mousedown", (e)=>{
    dragging = whichHit(e);
    if(dragging==="seek") setTimeFromClientX(e.clientX);
    e.preventDefault();
  });
  window.addEventListener("mousemove",(e)=>{
    if(!dragging) return;
    const dur = Number.isFinite(vid.duration)? vid.duration : 0;
    const r = ratioFromX(e.clientX);
    const t = r*dur;
    if(dragging==="A"){
      pointA = clamp(t, 0, dur);
      tcA.textContent = "A: " + fmtTC(pointA);
    }else if(dragging==="B"){
      pointB = clamp(t, 0, dur);
      tcB.textContent = "B: " + fmtTC(pointB);
    }else{
      setTimeFromClientX(e.clientX);
    }
    drawTL();
  });
  window.addEventListener("mouseup", ()=> dragging=null);

  // Scroll rueda ¬±2s
  tl.addEventListener("wheel",(e)=>{
    e.preventDefault();
    const delta = e.deltaY<0 ? 2 : -2;
    const dur = Number.isFinite(vid.duration)? vid.duration : 0;
    let t = clamp(vid.currentTime + delta, 0, dur);
    if(loopAB && abValid()) t = clamp(t, pointA, pointB);
    vid.currentTime = t; drawTL();
  }, {passive:false});

  // Atajos teclado
  window.addEventListener("keydown",(e)=>{
    if(e.target.closest("input,textarea")) return;
    if(e.code==="Space"){ e.preventDefault(); btnPlay.click(); }
    else if(e.code==="F11"){ e.preventDefault(); toggleFS(); }
    else if(e.key==="ArrowLeft"){ seekPercent(-0.10); }
    else if(e.key==="ArrowRight"){ seekPercent(+0.10); }
    else if(e.key==="ArrowUp"){ seekSeconds(+10); }
    else if(e.key==="ArrowDown"){ seekSeconds(-10); }
    else if(e.key==="4" && e.location===3){ seekPercent(-0.10); } // KP_4
    else if(e.key==="6" && e.location===3){ seekPercent(+0.10); } // KP_6
    else if(e.key==="8" && e.location===3){ seekSeconds(+10); }   // KP_8
    else if(e.key==="2" && e.location===3){ seekSeconds(-10); }   // KP_2
  });
  function seekSeconds(ds){
    const dur = Number.isFinite(vid.duration)? vid.duration : 0;
    let t = clamp(vid.currentTime + ds, 0, dur);
    if(loopAB && abValid()) t = clamp(t, pointA, pointB);
    vid.currentTime = t; drawTL();
  }
  function seekPercent(df){
    const dur = Number.isFinite(vid.duration)? vid.duration : 0;
    const step = dur * df;
    seekSeconds(step);
  }

  // --- Recorte con ffmpeg.wasm ---
  btnCut.addEventListener("click", async () => {
    if(!(abValid())) return toast("Marca correctamente A y B");
    if(!fileHandle){ return toast("Abre un archivo de v√≠deo local para recortar"); }
    btnCut.disabled = true;
    try{
      await ensureFFmpeg();
      const {name} = fileHandle;
      const inputName = name || "input.mp4";
      const data = new Uint8Array(await fileHandle.arrayBuffer());
      const fs = ffmpeg.FS;
      // limpiar FS virtual
      for(const f of fs.readdir("/")){ if(f !== "." && f !== "..") try{fs.unlink("/"+f)}catch{} }
      fs.writeFile(inputName, data);
      const toHHMMSS = s=>{
        const ms = Math.round((s%1)*1000);
        const sec = Math.floor(s)%60, min = Math.floor(s/60)%60, hr = Math.floor(s/3600);
        const z=n=>String(n).padStart(2,"0");
        return `${z(hr)}:${z(min)}:${z(sec)}.${String(ms).padStart(3,"0")}`;
      };
      const ss = toHHMMSS(pointA);
      const t  = toHHMMSS(pointB - pointA);
      const out = inputName.replace(/\.(\w+)$/i, (_,ext)=>` - (recortado ${ss.replace(/[:.]/g,"-")} a ${toHHMMSS(pointB).replace(/[:.]/g,"-")}).${ext}`);
      // primero intento 'copy' (r√°pido); si falla, recodifico H.264
      try{
        await ffmpeg.run("-y","-ss", ss, "-i", inputName, "-t", t, "-c","copy", out);
      }catch(e){
        await ffmpeg.run("-y","-ss", ss, "-i", inputName, "-t", t, "-c:v","libx264","-c:a","copy", out);
      }
      const outData = ffmpeg.FS("readFile", out);
      const blob = new Blob([outData.buffer], {type: fileHandle.type || "video/mp4"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = out;
      a.click();
      toast("Segmento recortado listo para descargar");
    }catch(err){
      console.error(err);
      toast("Error al recortar (ver consola)");
    }finally{
      btnCut.disabled = false;
    }
  });

  async function ensureFFmpeg(){
    if(ffmpegReady) return;
    // Carga perezosa desde CDN
    const mod = await import("https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js");
    const { createFFmpeg, fetchFile } = mod;
    ffmpeg = createFFmpeg({ log: false, corePath: "https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/ffmpeg-core.js" });
    toast("Cargando motor de recorte‚Ä¶");
    await ffmpeg.load();
    ffmpegReady = true;
  }

  // Inicial
  vid.controls = false; // usamos controles propios
  vid.addEventListener("loadedmetadata",()=> drawTL(), {once:true});
  // Para iOS, permitir autoplay tras user-gesture
  document.addEventListener("touchend", ()=>{ if(vid.paused && vid.src) vid.play().catch(()=>{}) }, {once:true});
</script>


</body></html>
