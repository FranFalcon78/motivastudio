<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CursoPlayer Web â€” by Fran FalcÃ³n (Rev 3)</title>
<meta name="theme-color" content="#131834">
<style>
  :root{
    --bg:#0d1021;         /* fondo general (azul oscuro) */
    --panel:#131834;      /* barras panel */
    --panel-2:#0f132b;
    --border:#1f264a;
    --text:#e9ecf5;
    --muted:#b5bdd6;
    --rail:#273058;
    --rail-fill:#c94055;  /* barra de progreso */
    --rail-ab:#ff5a5a99;
    --btn:#1a2144;
    --btn-h:#232c5b;
    --badge:#2b3a86;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
            font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Noto Sans", "Helvetica Neue", Arial;
            -webkit-user-select:none; user-select:none;}
  a{color:#9ec3ff;text-decoration:none}
  a:hover{text-decoration:underline}
  .app{display:grid;grid-template-rows:auto 1fr auto;gap:.6rem;height:100%;padding:.6rem}
  .shell{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:.5rem}
  .topbar{display:flex;gap:.45rem;align-items:center;flex-wrap:wrap}
  .brand{display:flex;gap:.5rem;align-items:center;margin-right:.25rem;font-weight:600}
  .badge{font-size:.75rem;background:var(--badge);border:1px solid var(--border);color:#bcd3ff;padding:.15rem .45rem;border-radius:999px}
  input#file{display:none}
  button{appearance:none;border:1px solid var(--border);background:var(--btn);color:var(--text);
         padding:.55rem .7rem;border-radius:10px;cursor:pointer;transition:.12s;white-space:nowrap}
  button:hover{background:var(--btn-h)}
  button.ghost{background:transparent}
  .btn-blue{background:#1e2f97} .btn-blue:hover{background:#2638af}
  .btn-green{background:#1d7a46} .btn-green:hover{background:#249a59}
  .btn-amber{background:#754d10} .btn-amber:hover{background:#946321}
  .btn-red{background:#79222b} .btn-red:hover{background:#962a36}
  .btn-dark{background:#1d2249} .btn-dark:hover{background:#242c62}
  .video-wrap{position:relative;background:black;border:1px solid var(--border);border-radius:14px;overflow:hidden;min-height:40vh}
  video{width:100%;height:100%;display:block;background:black}
  .mirror{transform:scaleX(-1)}
  .overlay{position:absolute;inset:0;pointer-events:none}
  /* Bottom area */
  .bottom{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:.6rem}
  .labels{display:flex;gap:.75rem;color:var(--muted)}
  .tc{color:var(--muted);font-variant-numeric:tabular-nums}
  .credit{grid-column:1/-1;color:#aeb6d3;font-size:.82rem;opacity:.9;text-align:center}
  /* Timeline */
  .tl{position:relative;height:36px;user-select:none}
  .tl-rail{position:absolute;left:2%;right:2%;top:50%;height:8px;transform:translateY(-50%);
           background:linear-gradient(180deg, #3a426b 0%, var(--rail) 100%);border-radius:999px;outline:1px solid var(--border)}
  .tl-fill{position:absolute;left:2%;top:50%;height:8px;transform:translateY(-50%);background:var(--rail-fill);border-radius:999px}
  .tl-ab{position:absolute;top:50%;height:14px;transform:translateY(-50%);background:var(--rail-ab);border-radius:8px}
  .tl-knob{position:absolute;top:50%;width:16px;height:16px;border-radius:50%;transform:translate(-50%,-50%);
           background:#ffd1d8;outline:1px solid #3a1e26;box-shadow:0 0 0 2px #0003}
  .tl-mark{position:absolute;top:50%;width:2px;height:18px;transform:translate(-50%,-50%);background:#ff6b6b}
  .tl-hit{position:absolute;inset:0;cursor:pointer}
  /* Responsive */
  @media (max-width:860px){
    .bottom{grid-template-columns:1fr;gap:.35rem}
    .credit{font-size:.78rem}
  }
</style>
</head>
<body oncontextmenu="return false">
<div class="app" id="app">
  <div class="shell">
    <div class="topbar" role="toolbar" aria-label="Controles de CursoPlayer">
      <div class="brand">CursoPlayer Web <span class="badge">PWA</span></div>
      <input id="file" type="file" accept="video/*" />
      <button id="openBtn" class="btn-dark">ðŸ“‚ Abrir</button>
      <button id="playBtn" class="btn-blue">â–¶ Reproducir</button>
      <button id="mirrorBtn" class="btn-dark">Espejo: OFF</button>
      <button id="infoBtn" class="ghost">â„¹ Info</button>
      <button id="fsBtn" class="ghost">Pantalla completa</button>
      <button id="rateDown" class="btn-amber">Vel-</button>
      <button id="rateUp" class="btn-amber">Vel+</button>
      <button id="rateReset" class="btn-amber">Vel 1.00x</button>
      <button id="markA" class="btn-green">Marca A</button>
      <button id="markB" class="btn-green">Marca B</button>
      <button id="clearAB" class="ghost">Desmarcar Aâ€‘B</button>
      <button id="loopBtn" class="btn-red">Bucle Aâ€‘B: OFF</button>
    </div>
  </div>

  <div class="video-wrap">
    <video id="vid" preload="metadata" playsinline></video>
    <div class="overlay"></div>
  </div>

  <div class="shell">
    <div class="bottom">
      <div class="labels">
        <span class="tc" id="tcA">A: --:--:--.---</span>
        <span class="tc" id="tcB">B: --:--:--.---</span>
      </div>
      <div class="tl" id="timeline" aria-label="LÃ­nea de tiempo">
        <div class="tl-rail"></div>
        <div class="tl-fill"></div>
        <div class="tl-ab" style="display:none"></div>
        <div class="tl-mark" id="markAline" style="display:none"></div>
        <div class="tl-mark" id="markBline" style="display:none"></div>
        <div class="tl-knob" style="left:0%"></div>
        <div class="tl-hit" title="Arrastra para navegar"></div>
      </div>
      <div class="tc"><span id="tcNow">00:00:00.000</span> / <span id="tcDur">00:00:00.000</span></div>
      <div class="credit">
        CursoPlayer Â© 2025 Francisco Javier FalcÃ³n MuÃ±oz â€”
        <a href="mailto:falcon.fjf@gmail.com" rel="author noopener noreferrer">falcon.fjf@gmail.com</a>
        &nbsp;â€¢&nbsp;
        <span class="tc">Atajos: Espacio reproducir/pausar Â· J/L velâ€‘/vel+ Â· K vel normal Â· A/B marcas Â· F pantalla completa</span>
      </div>
    </div>
  </div>
</div>

<!-- Modal Info -->
<div class="shell" id="infoModal" style="display:none; position:fixed; inset:0; background:#0007;align-items:center;justify-content:center;">
  <div style="background:var(--panel);border:1px solid var(--border);max-width:min(720px,90vw);border-radius:14px;padding:1rem">
    <h3 style="margin:.2rem 0 1rem">InformaciÃ³n del clip</h3>
    <div id="infoText" style="color:var(--muted)"></div>
    <div style="margin-top:.9rem;display:flex;gap:.5rem;justify-content:flex-end">
      <button id="closeInfo" class="ghost">Cerrar</button>
    </div>
  </div>
</div>

<script type="module">
  // === Utilidades ===
  const $ = (s)=>document.querySelector(s);
  const clamp = (v,a,b)=>Math.min(b,Math.max(a,v));
  const fmtTC = (sec)=>{
    if(!Number.isFinite(sec)||sec<0) sec=0;
    const ms = Math.round((sec%1)*1000);
    const s  = Math.floor(sec)%60;
    const m  = Math.floor(sec/60)%60;
    const h  = Math.floor(sec/3600);
    const z = (n)=>String(n).padStart(2,'0');
    return `${z(h)}:${z(m)}:${z(s)}.${String(ms).padStart(3,'0')}`;
  };

  // === Estado ===
  const vid = $("#vid");
  let fileHandle = null;
  let pointA = null, pointB = null;
  let loopAB = false;
  let dragging = null; // 'seek' | 'A' | 'B'
  let userRate = 1.0;

  // === Elementos ===
  const btnOpen = $("#openBtn");
  const fileInp = $("#file");
  const btnPlay = $("#playBtn");
  const btnMirror = $("#mirrorBtn");
  const btnInfo = $("#infoBtn");
  const btnFS = $("#fsBtn");
  const btnRateDn = $("#rateDown");
  const btnRateUp = $("#rateUp");
  const btnRateReset = $("#rateReset");
  const btnA = $("#markA");
  const btnB = $("#markB");
  const btnClear = $("#clearAB");
  const btnLoop = $("#loopBtn");

  const tl = $("#timeline");
  const tlFill = tl.querySelector(".tl-fill");
  const tlKnob = tl.querySelector(".tl-knob");
  const tlAB = tl.querySelector(".tl-ab");
  const tlHit = tl.querySelector(".tl-hit");
  const markAline = $("#markAline");
  const markBline = $("#markBline");
  const tcA = $("#tcA"), tcB = $("#tcB"), tcNow = $("#tcNow"), tcDur = $("#tcDur");

  // === Anti-copia bÃ¡sica ===
  document.addEventListener("keydown",(e)=>{
    if((e.ctrlKey||e.metaKey) && ["s","u","p","c","a"].includes(e.key.toLowerCase())) { e.preventDefault(); }
    if((e.ctrlKey||e.metaKey) && e.shiftKey && ["i","j","c"].includes(e.key.toLowerCase())) { e.preventDefault(); }
    if(e.key === "F12"){ e.preventDefault(); }
  });

  // === Archivo (botÃ³n + drag&drop) ===
  btnOpen.addEventListener("click",()=>fileInp.click());
  fileInp.addEventListener("change",(e)=>{
    const f = e.target.files?.[0];
    if(f) loadFile(f);
  });
  const dropArea = document.querySelector(".video-wrap");
  ["dragenter","dragover"].forEach(ev=>dropArea.addEventListener(ev,e=>{e.preventDefault();dropArea.style.outline="2px dashed #6aa2ff"}));
  ["dragleave","drop"].forEach(ev=>dropArea.addEventListener(ev,e=>{e.preventDefault();dropArea.style.outline="none"}));
  dropArea.addEventListener("drop",(e)=>{
    const f = [...e.dataTransfer.files].find(f=>f.type.startsWith("video/")) || e.dataTransfer.files[0];
    if(f) loadFile(f);
  });

  async function loadFile(file){
    fileHandle = file;
    const url = URL.createObjectURL(file);
    vid.src = url;
    await vid.play().catch(()=>{});
    btnPlay.textContent = "â¸ Pausa";
    resetAB();
    userRate = 1.0; applyRate();
  }

  // === Play/Pausa ===
  btnPlay.addEventListener("click",()=>{
    if(vid.paused){ vid.play(); btnPlay.textContent="â¸ Pausa"; }
    else { vid.pause(); btnPlay.textContent="â–¶ Reproducir"; }
  });

  // === Info ===
  const infoModal = $("#infoModal");
  const infoText = $("#infoText");
  btnInfo.addEventListener("click",()=>{
    const dur = Number.isFinite(vid.duration) ? fmtTC(vid.duration) : "--:--:--.---";
    const name = fileHandle?.name || "(sin archivo)";
    infoText.innerHTML = `<div><strong>Fichero:</strong> ${name}</div>
                          <div><strong>DuraciÃ³n:</strong> ${dur}</div>
                          <div><strong>Reproductor:</strong> HTML5 Video</div>`;
    infoModal.style.display="flex";
  });
  $("#closeInfo").addEventListener("click",()=> infoModal.style.display="none");
  infoModal.addEventListener("click",(e)=>{ if(e.target===infoModal) infoModal.style.display="none"; });

  // === Pantalla completa ===
  btnFS.addEventListener("click",()=>toggleFS());
  function toggleFS(){
    const el = document.documentElement;
    if(!document.fullscreenElement){ el.requestFullscreen?.(); btnFS.textContent="Salir pantalla completa"; }
    else { document.exitFullscreen?.(); btnFS.textContent="Pantalla completa"; }
  }
  document.addEventListener("fullscreenchange",()=>{
    btnFS.textContent = document.fullscreenElement? "Salir pantalla completa" : "Pantalla completa";
  });

  // === Espejo ===
  btnMirror.addEventListener("click",()=>{
    vid.classList.toggle("mirror");
    btnMirror.textContent = "Espejo: " + (vid.classList.contains("mirror") ? "ON" : "OFF");
  });

  // === Velocidad ===
  function applyRate(){ vid.playbackRate = userRate; $("#rateReset").textContent = `Vel ${userRate.toFixed(2)}x`; }
  btnRateDn.addEventListener("click",()=>{ userRate = clamp(userRate-0.1, 0.10, 3.0); applyRate(); });
  btnRateUp.addEventListener("click",()=>{ userRate = clamp(userRate+0.1, 0.10, 3.0); applyRate(); });
  btnRateReset.addEventListener("click",()=>{ userRate = 1.0; applyRate(); });

  // === Marcas A/B y bucle ===
  function resetAB(){
    pointA = pointB = null; loopAB=false;
    btnLoop.textContent = "Bucle Aâ€‘B: OFF";
    tcA.textContent = "A: --:--:--.---";
    tcB.textContent = "B: --:--:--.---";
    $("#markA").textContent = "Marca A";
    $("#markB").textContent = "Marca B";
    tlAB.style.display="none"; markAline.style.display="none"; markBline.style.display="none";
  }
  btnClear.addEventListener("click", resetAB);
  btnLoop.addEventListener("click",()=>{
    loopAB = !loopAB;
    btnLoop.textContent = "Bucle Aâ€‘B: " + (loopAB? "ON":"OFF");
  });
  btnA.addEventListener("click",()=>{
    if(pointA!=null){ pointA=null; tcA.textContent="A: --:--:--.---"; btnA.textContent="Marca A"; }
    else { pointA=vid.currentTime; tcA.textContent="A: "+fmtTC(pointA); btnA.textContent="Marca A âœ“"; }
    drawTL();
  });
  btnB.addEventListener("click",()=>{
    if(pointB!=null){ pointB=null; tcB.textContent="B: --:--:--.---"; btnB.textContent="Marca B"; }
    else { pointB=vid.currentTime; tcB.textContent="B: "+fmtTC(pointB); btnB.textContent="Marca B âœ“"; }
    drawTL();
  });
  const abValid = ()=> pointA!=null && pointB!=null && pointB>pointA;

  // === Timeline: pintar ===
  function drawTL(){
    const dur = Number.isFinite(vid.duration)? vid.duration : 0;
    const rNow = dur? (vid.currentTime/dur): 0;
    const railLeft = tl.querySelector(".tl-rail").getBoundingClientRect().left;
    const railRight = tl.querySelector(".tl-rail").getBoundingClientRect().right;
    const railWidth = railRight - railLeft;
    tlKnob.style.left = `${2 + rNow*(100-4)}%`;  /* 2% margen izq-dcha */
    tlFill.style.left = "2%";
    tlFill.style.width = `${rNow*(100-4)}%`;
    tcNow.textContent = fmtTC(vid.currentTime||0);
    tcDur.textContent = fmtTC(dur||0);

    // Marcas
    const posPct = (t)=> (2 + clamp(t/dur,0,1)*(100-4));
    if(pointA!=null){ markAline.style.left = posPct(pointA)+"%"; markAline.style.display="block"; }
    else markAline.style.display="none";
    if(pointB!=null){ markBline.style.left = posPct(pointB)+"%"; markBline.style.display="block"; }
    else markBline.style.display="none";

    if(abValid()){
      const left = posPct(Math.min(pointA,pointB));
      const right = posPct(Math.max(pointA,pointB));
      tlAB.style.display="block";
      tlAB.style.left = left+"%";
      tlAB.style.right = (100-right)+"%";
    } else tlAB.style.display="none";
  }
  vid.addEventListener("timeupdate", drawTL);
  vid.addEventListener("durationchange", drawTL);
  vid.addEventListener("loadedmetadata", drawTL);

  // === LÃ³gica de bucle y final ===
  vid.addEventListener("timeupdate", ()=>{
    if(loopAB && abValid()){
      if(vid.currentTime < pointA) vid.currentTime = pointA;
      if(vid.currentTime >= pointB) vid.currentTime = pointA;
    }
  });
  vid.addEventListener("ended", ()=>{
    if(loopAB && abValid()) { vid.currentTime = pointA; vid.play(); }
    else { vid.currentTime = 0; vid.play(); }
  });

  // === InteracciÃ³n timeline: click/drag y arrastre de marcas ===
  function whichHit(e){
    const rect = tl.getBoundingClientRect();
    const railRect = tl.querySelector(".tl-rail").getBoundingClientRect();
    const x = e.clientX;
    const near = (px)=>Math.abs(px-x)<=10;
    const dur = Number.isFinite(vid.duration)? vid.duration : 0;
    const rA = pointA!=null? (pointA/dur): null;
    const rB = pointB!=null? (pointB/dur): null;
    const xA = rA!=null? (railRect.left + (railRect.width)*rA): null;
    const xB = rB!=null? (railRect.left + (railRect.width)*rB): null;
    if(xA!=null && near(xA)) return "A";
    if(xB!=null && near(xB)) return "B";
    return "seek";
  }
  function setTimeFromClientX(clientX){
    const railRect = tl.querySelector(".tl-rail").getBoundingClientRect();
    const r = clamp((clientX-railRect.left)/railRect.width,0,1);
    const dur = Number.isFinite(vid.duration)? vid.duration : 0;
    let t = r*dur;
    if(loopAB && abValid()) t = clamp(t, pointA, pointB);
    vid.currentTime = t; drawTL();
  }
  tlHit.addEventListener("mousedown",(e)=>{
    dragging = whichHit(e);
    if(dragging==="seek") setTimeFromClientX(e.clientX);
    e.preventDefault();
  });
  window.addEventListener("mousemove",(e)=>{
    if(!dragging) return;
    const railRect = tl.querySelector(".tl-rail").getBoundingClientRect();
    const r = clamp((e.clientX-railRect.left)/railRect.width,0,1);
    const dur = Number.isFinite(vid.duration)? vid.duration : 0;
    const t = r*dur;
    if(dragging==="A"){ pointA = clamp(t,0,dur); tcA.textContent="A: "+fmtTC(pointA); }
    else if(dragging==="B"){ pointB = clamp(t,0,dur); tcB.textContent="B: "+fmtTC(pointB); }
    else setTimeFromClientX(e.clientX);
    drawTL();
  });
  window.addEventListener("mouseup",()=> dragging=null);

  // === Rueda: Â±2s ===
  tl.addEventListener("wheel",(e)=>{
    e.preventDefault();
    const delta = e.deltaY<0 ? 2 : -2;
    const dur = Number.isFinite(vid.duration)? vid.duration : 0;
    let t = clamp(vid.currentTime + delta, 0, dur);
    if(loopAB && abValid()) t = clamp(t, pointA, pointB);
    vid.currentTime = t; drawTL();
  }, {passive:false});

  // === Atajos de teclado visibles en el pie ===
  window.addEventListener("keydown",(e)=>{
    if((e.ctrlKey||e.metaKey) && ["s","u","p","c","a"].includes(e.key.toLowerCase())) { e.preventDefault(); return; }
    if((e.ctrlKey||e.metaKey) && e.shiftKey && ["i","j","c"].includes(e.key.toLowerCase())) { e.preventDefault(); return; }
    if(e.key === "F12"){ e.preventDefault(); return; }
    if(e.target.closest("input,textarea")) return;

    const k = e.key.toLowerCase();
    if(k===" "){ e.preventDefault(); btnPlay.click(); }
    else if(k==="j"){ e.preventDefault(); btnRateDn.click(); }
    else if(k==="l"){ e.preventDefault(); btnRateUp.click(); }
    else if(k==="k"){ e.preventDefault(); btnRateReset.click(); }
    else if(k==="a"){ e.preventDefault(); btnA.click(); }
    else if(k==="b"){ e.preventDefault(); btnB.click(); }
    else if(k==="f"){ e.preventDefault(); btnFS.click(); }
    else if(k==="arrowleft"){ seekPercent(-0.10); }
    else if(k==="arrowright"){ seekPercent(+0.10); }
    else if(k==="arrowup"){ seekSeconds(+10); }
    else if(k==="arrowdown"){ seekSeconds(-10); }
  });
  function seekSeconds(ds){
    const dur = Number.isFinite(vid.duration)? vid.duration : 0;
    let t = clamp(vid.currentTime + ds, 0, dur);
    if(loopAB && abValid()) t = clamp(t, pointA, pointB);
    vid.currentTime = t; drawTL();
  }
  function seekPercent(df){
    const dur = Number.isFinite(vid.duration)? vid.duration : 0;
    seekSeconds(dur * df);
  }

  // Inicial
  vid.controls = false;
</script>
</body>
</html>
