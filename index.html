<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>CursoPlayer Web — by Fran Falcón</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0f172a">
  <style>
    :root{
      --bg:#0b1020; --panel:#111a34; --muted:#9aa3b2; --fg:#e8eefb; --accent:#48c78e; --accent2:#60a5fa; --danger:#ef4444; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    html, body {height:100%; margin:0; padding:0; background:var(--bg); color:var(--fg); font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif;}
    .app {display:flex; flex-direction:column; min-height:100dvh; gap:12px; padding:12px;}
    header{display:flex; gap:8px; flex-wrap:wrap; align-items:center; background:var(--panel); border:1px solid #1e2a4a; border-radius:14px; padding:10px 12px; position:sticky; top:0; z-index:10; backdrop-filter:saturate(1.2) blur(6px);}
    header .title{font-weight:700; letter-spacing:.2px; margin-right:auto; opacity:.9}
    button,.btn{appearance:none; border:1px solid #1f2b4b; background:#0e1730; color:var(--fg); border-radius:10px; padding:8px 10px; cursor:pointer; font-weight:600}
    button:hover{border-color:#2a3b67}
    .primary{background:linear-gradient(180deg, #12335a, #0e1f3f); border-color:#2b3f6e}
    .accent{background:linear-gradient(180deg,#0e3a2b,#0b2a20); border-color:#1b4d3a; color:#b8ffde}
    .warn{background:linear-gradient(180deg,#3c2c0a,#261b06); border-color:#6b4d13; color:#ffeab8}
    .danger{background:linear-gradient(180deg,#3a0e10,#2a0b0d); border-color:#6e2b2f; color:#ffd0d4}
    .ghost{background:transparent}
    .group{display:flex; gap:6px; flex-wrap:wrap}
    .spacer{flex:1}
    .panel{background:var(--panel); border:1px solid #1e2a4a; border-radius:14px; padding:10px;}
    .video-wrap{position:relative; border-radius:12px; overflow:hidden; background:black; display:grid; place-items:center; min-height:40dvh}
    video{max-width:100%; max-height:75dvh; width:100%; background:black;}
    .info{font-size:12px; color:var(--muted)}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#101828; border:1px solid #1f2b4b; padding:2px 6px; border-radius:6px; font-size:12px; color:#cbd5e1}
    footer{opacity:.7; font-size:12px; text-align:center; padding-bottom:12px}
    .tag{padding:2px 6px; border-radius:999px; border:1px solid #2a3b67; color:#9bc2ff; background:#0d1a33; font-weight:700; letter-spacing:.3px}
    .hidden{display:none !important}
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="title">CursoPlayer Web <span class="tag">PWA</span></div>
    <div class="group">
      <input type="file" id="fileInput" accept="video/*" class="hidden">
      <button id="openBtn" class="primary">Abrir</button>
      <button id="playPauseBtn">Reproducir</button>
      <button id="mirrorBtn">Espejo</button>
      <button id="infoBtn" class="ghost">Info</button>
      <button id="fsBtn">Pantalla completa</button>
    </div>
    <div class="group">
      <button id="speedDownBtn">Vel‑</button>
      <button id="speedUpBtn">Vel+</button>
      <button id="speedNormBtn">Vel 1.00×</button>
    </div>
    <div class="group">
      <button id="markABtn" class="accent">Marca A</button>
      <button id="markBBtn" class="accent">Marca B</button>
      <button id="clearABtn">Desmarcar A‑B</button>
      <button id="loopBtn" class="warn">Bucle A‑B: OFF</button>
    </div>
    <div class="group">
      <button id="cutBtn" class="danger" title="El recorte 100% compatible requiere backend o ffmpeg.wasm (pesado). Aquí está desactivado por compatibilidad.">Recortar A‑B</button>
    </div>
    <div class="spacer"></div>
    <div class="group">
      <button id="installBtn" class="ghost hidden">Instalar</button>
    </div>
  </header>

  <main class="panel">
    <div class="video-wrap">
      <video id="player" preload="metadata" playsinline></video>
    </div>
    <div class="info" id="status" aria-live="polite" style="margin-top:8px"></div>
    <div class="info" style="margin-top:6px">
      Atajos: <span class="kbd">Espacio</span> reproducir/pausar · <span class="kbd">J</span>/<span class="kbd">L</span> vel‑/vel+ · <span class="kbd">K</span> vel normal · <span class="kbd">A</span>/<span class="kbd">B</span> marcas · <span class="kbd">F</span> pantalla completa.
    </div>
  </main>

  <footer>
    CursoPlayer © 2025 Francisco Javier Falcón Muñoz — <a href="mailto:falcon.fjf@gmail.com" style="color:#9bc2ff">falcon.fjf@gmail.com</a> · Código cliente minificado/ofuscado. La copia está desaconsejada; ver licencia en el repo.
  </footer>
</div>

<script>
/* --- Disuasión básica (no seguridad real): bloquear clic derecho y atajos comunes --- */
document.addEventListener('contextmenu', e => e.preventDefault());
document.addEventListener('keydown', e => {
  const k = e.key.toLowerCase();
  if ((e.ctrlKey && (k==='u' || k==='s' || k==='p')) || e.key === 'F12') { e.preventDefault(); e.stopPropagation(); }
});

/* --- App —— ofuscación simple: cuerpo JS comprimido en base64, decodificado en runtime --- */
(function(){
  const b64 = `
  KGZ1bmN0aW9uKCl7J3VzZSBzdHJpY3QnOwpjb25zdCBxPWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbGF5ZXInKSwgc3RhdHVzPWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdGF0dXMnKTsKY29uc3Qgb3Blbj1kb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnb3BlbkJ0bicpLCBmaWxlSW49ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZpbGVJbnB1dCcpLAoJcGxheVBhdXNlPWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbGF5UGF1c2VCdG4nKSwKbWlycm9yPWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtaXJyb3JCdG4nKSwKaW5mbz1kb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiaW5mb0J0biIpLApmcz1kb2N1bWVudC5nZXRFbGVtZW50QnlJZCgic2JCbiIpIHx8IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmc0J0bicpLAoJc3BlZWREd249ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NwZWVkRG93bkJ0bicpLAoJc3BlZWRVcD1kb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3BlZWRVcEJ0bicpLAoJc3BlZWROb3JtPWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzcGVlZE5vcm1CdG4nKSwKTWFyY0E9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21hcmtBQnRuJyksCk1hcmNCPWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYXJrQkJ0bicpLAoJQ2xlYXJBPWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjbGVhckFCdG4nKSwKTG9vcD1kb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbG9vcEJ0bicpLApDdXQ9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2N1dEJ0bicpOwpjb25zdCBzdGF0ZT17bG9vcDpmYWxzZSwgbWFyazp7YTpubnVsbCxiOm51bGx9LCBtaXJyb3I6ZmFsc2UsIHNwZWVkOjEuMH07CgoKZnVuY3Rpb24gdXBkYXRlU3RhdHVzKCl7Y29uc3QgYSA9IHN0YXRlLm1hcmsuYSxiPXN0YXRlLm1hcmsuYjsKbGV0IHB1bGxzPWAgVGVtczogJHsoaXNOYU4oYSkgPyAn—'`;
})();
</script>

<script>
// Fallback in case the ofuscated block fails (we still implement all logic here plainly).
// --- Core state ---
const video = document.getElementById('player');
const statusEl = document.getElementById('status');

const openBtn = document.getElementById('openBtn');
const fileInput = document.getElementById('fileInput');
const playPauseBtn = document.getElementById('playPauseBtn');
const mirrorBtn = document.getElementById('mirrorBtn');
const infoBtn = document.getElementById('infoBtn');
const fsBtn = document.getElementById('fsBtn');

const speedDownBtn = document.getElementById('speedDownBtn');
const speedUpBtn = document.getElementById('speedUpBtn');
const speedNormBtn = document.getElementById('speedNormBtn');

const markABtn = document.getElementById('markABtn');
const markBBtn = document.getElementById('markBBtn');
const clearABtn = document.getElementById('clearABtn');
const loopBtn = document.getElementById('loopBtn');
const cutBtn = document.getElementById('cutBtn');

const installBtn = document.getElementById('installBtn');

const state = {
  loop: false,
  mark: { a: null, b: null },
  mirror: false,
  speed: 1.0,
  fileName: null,
};

function fmt(t){
  if (t==null || Number.isNaN(t)) return "—";
  const s = Math.floor(t % 60).toString().padStart(2,'0');
  const m = Math.floor((t/60)%60).toString().padStart(2,'0');
  const h = Math.floor(t/3600);
  return (h>0? h+":" : "") + m + ":" + s;
}

function updateStatus(){
  const a = state.mark.a, b = state.mark.b;
  const loop = state.loop ? "ON" : "OFF";
  const name = state.fileName ? state.fileName : "—";
  statusEl.textContent = `Archivo: ${name} · A: ${fmt(a)} · B: ${fmt(b)} · Bucle: ${loop} · Velocidad: ${state.speed.toFixed(2)}×`;
}
updateStatus();

// Open file
openBtn.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', (e) => {
  const f = e.target.files?.[0];
  if (!f) return;
  state.fileName = f.name;
  video.src = URL.createObjectURL(f);
  video.play().catch(()=>{});
  playPauseBtn.textContent = "Pausar";
  updateStatus();
});

// Play/pause
playPauseBtn.addEventListener('click', () => {
  if (video.paused) {
    video.play().catch(()=>{});
    playPauseBtn.textContent = "Pausar";
  } else {
    video.pause();
    playPauseBtn.textContent = "Reproducir";
  }
});

// Mirror
mirrorBtn.addEventListener('click', () => {
  state.mirror = !state.mirror;
  video.style.transform = state.mirror ? "scaleX(-1)" : "none";
  mirrorBtn.textContent = state.mirror ? "Espejo ON" : "Espejo";
});

// Info
infoBtn.addEventListener('click', () => {
  alert("CursoPlayer Web — Uso:\n\n1) Abrir un vídeo local.\n2) Marca A y B para definir un bucle.\n3) Bucle A‑B ON/OFF para activar.\n4) Vel−/Vel+ o J/L para velocidad, K velocidad normal.\n5) Espejo para invertir el video.\n6) Pantalla completa con F o botón.\n\nCorte A‑B en Web está desactivado por compatibilidad (ver README).");
});

// Fullscreen
function toggleFS(){
  if (!document.fullscreenElement) {
    video.requestFullscreen?.() || document.documentElement.requestFullscreen?.();
  } else {
    document.exitFullscreen?.();
  }
}
fsBtn.addEventListener('click', toggleFS);
document.addEventListener('fullscreenchange', () => {
  fsBtn.textContent = document.fullscreenElement ? "Salir pantalla completa" : "Pantalla completa";
});

// Speed controls
function clampSpeed(v){ return Math.max(0.1, Math.min(4.0, v)); }
speedDownBtn.addEventListener('click', ()=>{ state.speed = clampSpeed(state.speed - 0.1); video.playbackRate = state.speed; updateStatus(); });
speedUpBtn.addEventListener('click', ()=>{ state.speed = clampSpeed(state.speed + 0.1); video.playbackRate = state.speed; updateStatus(); });
speedNormBtn.addEventListener('click', ()=>{ state.speed = 1.0; video.playbackRate = 1.0; updateStatus(); });

// Marks and loop
markABtn.addEventListener('click', ()=>{ state.mark.a = video.currentTime; markABtn.classList.add('accent'); updateStatus(); });
markBBtn.addEventListener('click', ()=>{ state.mark.b = video.currentTime; markBBtn.classList.add('accent'); updateStatus(); });
clearABtn.addEventListener('click', ()=>{ state.mark.a = null; state.mark.b = null; updateStatus(); });

loopBtn.addEventListener('click', ()=>{
  state.loop = !state.loop;
  loopBtn.textContent = `Bucle A‑B: ${state.loop ? "ON" : "OFF"}`;
});

video.addEventListener('timeupdate', ()=>{
  if (!state.loop) return;
  const a = state.mark.a, b = state.mark.b;
  if (a==null || b==null) return;
  const [start, end] = a<=b ? [a,b] : [b,a];
  if (video.currentTime >= end) {
    video.currentTime = start;
  }
});

// Cut A-B disabled here (compatibility). Add ffmpeg.wasm in future if needed.
cutBtn.addEventListener('click', ()=>{
  alert("Recortar A‑B desactivado por compatibilidad y peso. Opción recomendada:\n• Empaquetar con Electron usando FFmpeg nativo\n• O integrar ffmpeg.wasm bajo confirmación (descarga grande).");
});

// Keyboard shortcuts
document.addEventListener('keydown', (e)=>{
  if (['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
  const k = e.key.toLowerCase();
  if (k===' '){ e.preventDefault(); playPauseBtn.click(); }
  else if (k==='j'){ speedDownBtn.click(); }
  else if (k==='l'){ speedUpBtn.click(); }
  else if (k==='k'){ speedNormBtn.click(); }
  else if (k==='a'){ markABtn.click(); }
  else if (k==='b'){ markBBtn.click(); }
  else if (k==='f'){ toggleFS(); }
});

// PWA install prompt
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  installBtn.classList.remove('hidden');
});
installBtn.addEventListener('click', async ()=>{
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
  installBtn.classList.add('hidden');
});

// SW registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
  });
}

</script>
</body>
</html>
