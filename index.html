<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CursoPlayer Minimal (Rev 23)</title>
<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden;font-family:system-ui}
  video{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;background:#000}
  .bg-frame{position:fixed;inset:0;z-index:-1;background:#000 center/120% cover no-repeat;filter:blur(10px);opacity:0;transition:opacity .35s ease;}
  .brand{position:absolute;top:10px;left:12px;z-index:20;color:#fff;font-size:12px;opacity:.85;letter-spacing:.2px;background:rgba(0,0,0,.25);padding:4px 8px;border-radius:8px;user-select:none;pointer-events:none}
.file-name{
  position:absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  z-index:20;
  color:#fff;
  font-size:12px;
  opacity:.92;
  background:rgba(0,0,0,.35);
  padding:4px 12px;
  border-radius:999px;
  max-width:60vw;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
  .ctrls{position:absolute;bottom:12vh;left:0;right:0;display:flex;justify-content:center;align-items:center;gap:1rem;pointer-events:auto;z-index:10}
  .btn{min-width:42px;height:42px;border-radius:50%;background:rgba(255,255,255,.18);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.2s;border:1px solid rgba(255,255,255,.25);position:relative;color:#fff}
  .btn:hover{background:rgba(255,255,255,.28)}
  .btn svg{width:22px;height:22px;stroke:#fff;fill:none;stroke-width:2;opacity:.95}
  .btn--text{min-width:72px;width:auto;padding:0 .6rem;border-radius:10px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);color:#fff;opacity:.95;text-align:center;cursor:pointer}
  .active{box-shadow:0 0 0 2px rgba(255,255,255,.55) inset,0 0 12px rgba(255,255,255,.35)}
  .active svg{opacity:1}
  input[type=file]{display:none}
  .pulse::after{content:"";position:absolute;inset:-2px;border-radius:inherit;box-shadow:0 0 0 3px rgba(255,255,255,.6);animation:pulse .18s ease-out forwards}
  @keyframes pulse{from{opacity:1;transform:scale(1)}to{opacity:0;transform:scale(1.15)}}

  .seek{position:absolute;left:0;right:0;bottom:4vh;height:28px;z-index:12;cursor:pointer}
  .seek-inner{position:absolute;left:2vw;right:2vw;top:50%;transform:translateY(-50%);height:28px}
  .track{position:absolute;left:0;right:0;top:50%;transform:translateY(-50%);height:2px;background:#ffffffcc;border-radius:2px;pointer-events:none}
  .trail{position:absolute;left:0;top:50%;transform:translateY(-50%);height:6px;background:rgba(255,255,255,.35);border-radius:6px;width:0%;pointer-events:none}
  .dot{position:absolute;top:50%;transform:translate(-50%,-50%);width:14px;height:14px;border-radius:50%;background:#fff;box-shadow:0 0 0 2px rgba(255,255,255,.35);left:0%;pointer-events:none}

  /* Marcas A y B: líneas verticales sobre la línea de tiempo */
  .mark{
    position:absolute;
    top:50%;                 /* centrado vertical sobre la barra de tiempo */
    transform:translateX(-50%);
    width:0;
    height:0;
    pointer-events:auto;
    cursor:default;
    opacity:0;
  }
  .mark::before{
    content:"";
    position:absolute;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    width:2px;
    height:22px;             /* longitud total de la marca vertical */
    background:#ffffffee;
    border-radius:2px;
    box-shadow:0 0 6px rgba(255,255,255,.35);
  }
  .mark.show{opacity:1}
  .mark-label{
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    padding:4px 8px;
    font-size:11px;
    background:rgba(255,255,255,.18);
    border:1px solid rgba(255,255,255,.25);
    border-radius:10px;
    color:#fff;
    white-space:nowrap;
    backdrop-filter:blur(4px);
    box-shadow:0 0 8px rgba(0,0,0,.35);
  }

    .mark-labelA{
    top: 10px;     /* bocadillo A: pegado a la marca por debajo */
  }

  .mark-labelB{
    top: -34px;    /* bocadillo B: encima de la línea de tiempo */
  }

.time-label{
    position:absolute;
    padding:4px 8px;
    font-size:11px;
    background:rgba(255,255,255,.18);
    border:1px solid rgba(255,255,255,.25);
    border-radius:10px;
    color:#fff;
    white-space:nowrap;
    backdrop-filter:blur(4px);
    box-shadow:0 0 8px rgba(0,0,0,.35);
  }
  .time-label-start{
    left:0;
    top:-21px;    /* bocadillo inicio: bajo la línea de tiempo, al inicio */
  }
  .time-label-end{
    right:0;
    top:24px;    /* bocadillo final: bajo la línea de tiempo, al final */
  }

.ab-range{
    position:absolute;
    top:50%;
    transform:translateY(-50%);
    height:8px;
    background:rgba(255,255,255,.58);
    border-radius:8px;
    left:0;width:0;
    pointer-events:none;
    opacity:0
  }
  .ab-range.show{opacity:1}
  .ab-range.loop-active{filter:blur(3px);}

  .info{position:absolute;right:12px;top:12px;z-index:25;max-width:min(92vw,520px);background:rgba(0,0,0,.55);color:#fff;border:1px solid rgba(255,255,255,.25);padding:12px 14px;border-radius:12px;backdrop-filter:blur(4px);display:none;line-height:1.35}
  .info h3{margin:.2rem 0 .6rem;font-size:14px;opacity:.95}
  .info p{margin:.25rem 0;font-size:13px;opacity:.95;white-space:pre-line}
  .hidden{display:none!important}

  .vol-pop{
    position:absolute;
    top:50%;
    left:100%;
    transform:translate(8px,-50%);
    z-index:15;
    background:rgba(255,255,255,.18);
    border:1px solid rgba(255,255,255,.25);
    border-radius:10px;
    padding:8px 10px;
    display:none;
    backdrop-filter:blur(4px);
    align-items:center;
    justify-content:center;
    flex-direction:row;
    width:auto;
    min-width:120px;
  }
  .vol-pop input[type=range]{
    width:120px;
    appearance:none;
    background:transparent;
  }
  .vol-pop input[type=range]::-webkit-slider-runnable-track{
    height:2px;
    background:#ffffff66;
    border-radius:4px
  }
  .vol-pop input[type=range]::-webkit-slider-thumb{
    appearance:none;
    width:14px;height:14px;
    border-radius:50%;
    background:#fff;
    margin-top:-6px;
    box-shadow:0 0 0 2px rgba(255,255,255,.35)
  }
  .vol-pop input[type=range]::-moz-range-track{
    height:2px;
    background:#ffffff66;
    border-radius:4px
  }
  .vol-pop input[type=range]::-moz-range-thumb{
    width:14px;height:14px;
    border-radius:50%;
    background:#fff;
    border:none
  }

  /* Tooltips de botones (negros, como antes) */
  .btn[data-tip]::before{
    content:attr(data-tip);
    position:absolute;
    bottom:48px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(0,0,0,.8);
    color:#fff;
    font-size:11px;
    padding:3px 6px;
    border-radius:6px;
    white-space:nowrap;
    opacity:0;
    pointer-events:none;
    transition:opacity .12s ease-out;
  }
  .btn[data-tip]:hover::before{
    opacity:1;
  }

    /* Información de marcas integrada en los triángulos (mark-label) */

</style>
</head>
<body>

<div class="brand">CursoPlayerWeb — © 2025 Fran Falcón</div>

<div class="file-name" id="fileNameLabel">Sin archivo</div>

<div id="bgFrame" class="bg-frame"></div>

<input id="file" type="file" accept="video/*">
<video id="vid" playsinline></video>

<div class="seek" id="seek">
  <div class="seek-inner" id="seekInner">
    <div class="trail" id="trail"></div>
    <div class="ab-range" id="abRange"></div>
    <div class="track"></div>
    <div class="mark markA" id="markA"></div>
    <div class="mark markB" id="markB"></div>
    <div class="dot" id="dot"></div>
    <div class="time-label time-label-start" id="timeStartLabel">00:00:00.0</div>
    <div class="time-label time-label-end" id="timeEndLabel">00:00:00.0</div>
  </div>
</div>

<div class="info" id="infoPanel">
  <h3>Información del archivo</h3>
  <p id="infoMeta">Abre un vídeo para ver los detalles.</p>
  <h3>Acerca de</h3>
  <p id="aboutMeta"></p>
</div>

<div class="ctrls" id="ctrls">
  <div class="btn" id="open" data-tip="Abrir vídeo">
    <svg viewBox="0 0 24 24">
      <path d="M3 7h5l2 3h11v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
      <path d="M3 7V5a2 2 0 0 1 2-2h5l2 2"/>
    </svg>
  </div>

  <div class="btn" id="zoomBtn" data-tip="Zoom">
    <svg viewBox="0 0 24 24">
      <circle cx="11" cy="11" r="5"/>
      <path d="M16 16l4 4"/>
      <path d="M11 8v6"/>
      <path d="M8 11h6"/>
    </svg>
  </div>

  <div class="btn" id="infoBtn" data-tip="Información">
    <svg viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="9"/>
      <path d="M12 16v-5"/>
      <circle cx="12" cy="8" r="1"/>
    </svg>
  </div>

  <div class="btn" id="play" data-tip="Reproducir / Pausa">
    <svg id="playIcon" viewBox="0 0 24 24">
      <path d="M8 5v14l11-7z" id="playShape"/>
    </svg>
  </div>

  <div class="btn" id="mirror" data-tip="Espejo">
    <svg viewBox="0 0 24 24">
      <path d="M2 7h20M2 17h20"/>
      <path d="M12 3v18"/>
    </svg>
  </div>

  <div class="btn" id="speedDown" data-tip="Velocidad -">
    <svg viewBox="0 0 24 24">
      <path d="M5 12h14"/>
    </svg>
  </div>

  <div class="btn btn--text" id="rateLabel" data-tip="Velocidad actual (click para 1.00×)">1.00×</div>

  <div class="btn" id="speedUp" data-tip="Velocidad +">
    <svg viewBox="0 0 24 24">
      <path d="M12 5v14M5 12h14"/>
    </svg>
  </div>

  <div class="btn" id="fs" data-tip="Pantalla completa">
    <svg viewBox="0 0 24 24">
      <path d="M7 3H3v4M17 3h4v4M21 17v4h-4M3 17v4h4"/>
    </svg>
  </div>

  <div class="btn" id="clearAB" data-tip="Desmarcar A-B">
    <svg viewBox="0 0 24 24">
      <path d="M18 6L6 18M6 6l12 12"/>
    </svg>
  </div>

  <div class="btn" id="loop" data-tip="Bucle A-B">
    <svg viewBox="0 0 24 24">
      <path d="M4 10a6 6 0 0 1 6-6h5"/>
      <path d="M15 4l-2-2 2-2"/>
      <path d="M20 14a6 6 0 0 1-6 6h-5"/>
      <path d="M9 20l2 2-2 2"/>
    </svg>
  </div>

  <div class="btn" id="volumeBtn" data-tip="Volumen">
    <svg viewBox="0 0 24 24">
      <path d="M3 10h4l5-4v12l-5-4H3z"/>
      <path d="M16 8a4 4 0 0 1 0 8"/>
    </svg>
    <div class="vol-pop" id="volPop">
      <input id="volRange" type="range" min="0" max="1" step="0.01" value="1">
    </div>
  </div>
</div>

<script>
const vid = document.querySelector("#vid");
const file = document.querySelector("#file");
const seek = document.querySelector("#seek");
const bgFrame = document.querySelector("#bgFrame");
const inner = document.querySelector("#seekInner");
const trail = document.querySelector("#trail");
const dot = document.querySelector("#dot");
const markAEl = document.querySelector("#markA");
const markBEl = document.querySelector("#markB");
const abRange = document.querySelector("#abRange");
const timeStartLabel = document.querySelector("#timeStartLabel");
const timeEndLabel = document.querySelector("#timeEndLabel");
const markALabel = document.createElement("div");
markALabel.className = "mark-label mark-labelA";
markAEl.appendChild(markALabel);
const markBLabel = document.createElement("div");
markBLabel.className = "mark-label mark-labelB";
markBEl.appendChild(markBLabel);


const openBtn   = document.querySelector("#open");
const playBtn   = document.querySelector("#play");
const playShape = document.querySelector("#playShape");
const mirrorBtn = document.querySelector("#mirror");
const loopBtn   = document.querySelector("#loop");
const clearABBtn= document.querySelector("#clearAB");
const rateLabel = document.querySelector("#rateLabel");
const speedDownBtn = document.querySelector("#speedDown");
const speedUpBtn   = document.querySelector("#speedUp");
const infoBtn   = document.querySelector("#infoBtn");
const infoPanel = document.querySelector("#infoPanel");
const infoMeta  = document.querySelector("#infoMeta");
const aboutMeta = document.querySelector("#aboutMeta");
const volumeBtn = document.querySelector("#volumeBtn");
const volPop    = document.querySelector("#volPop");
const volRange  = document.querySelector("#volRange");
const fsBtn     = document.querySelector("#fs");

let A=null,B=null, loopAB=false, rate=1, isMirrored=false;
let zoomLevel = 1;
const MIN_AB_GAP = 0.2; // separación mínima en segundos entre A y B
let isSeeking=false;
let draggingMark = null;
let currentFile = null;

// anti guardado básico
document.addEventListener("contextmenu",(e)=>e.preventDefault(),{passive:false});
document.addEventListener("keydown",(e)=>{
  // Bloqueo de atajos de guardado/impresión
  if((e.ctrlKey||e.metaKey) && (["s","p","u","S","P","U"].includes(e.key))){
    e.preventDefault();
    return;
  }
  // Flechas izquierda/derecha: desplazamiento de 10 segundos
  if(e.key === "ArrowLeft"){
    e.preventDefault();
    seekRelative(-10);
    return;
  }
  if(e.key === "ArrowRight"){
    e.preventDefault();
    seekRelative(10);
    return;
  }
  // F11: pantalla completa usando la misma lógica que el botón
  if(e.key === "F11"){
    e.preventDefault();
    toggleFS();
    return;
  }
},{passive:false});

function pulse(el){
  el.classList.remove("pulse");void el.offsetWidth;el.classList.add("pulse");
}

/* Estados de UI dependientes de rate */
function updateRateUI(){
  rateLabel.textContent = rate.toFixed(2)+"×";
  const isNormal = Math.abs(rate-1) < 0.001;
  rateLabel.classList.toggle("active", isNormal);
  speedDownBtn.classList.toggle("active", rate < 1);
  speedUpBtn.classList.toggle("active", rate > 1);
}

/* Estado del botón de volumen */
function updateVolumeUI(){
  volumeBtn.classList.toggle("active", vid.volume > 0);
}

function applyVideoTransform(){
  if(isMirrored){
    vid.style.transform = `scale(${-zoomLevel}, ${zoomLevel})`;
  }else{
    vid.style.transform = `scale(${zoomLevel})`;
  }
}

function updateZoomUI(){
  zoomBtn.classList.toggle("active", Math.abs(zoomLevel-1) > 0.001);
  applyVideoTransform();
}

function updateTimeLabels(){
  const cur = vid.currentTime || 0;
  const total = (vid.duration && isFinite(vid.duration)) ? vid.duration : 0;
  if(timeStartLabel) timeStartLabel.textContent = formatTimeWithTenths(cur);
  if(timeEndLabel)   timeEndLabel.textContent   = formatTimeWithTenths(total);
}

function updateLoopBtnState(){
  const hasMarks = (A != null && B != null);
  loopBtn.classList.toggle("active", hasMarks);
}

/* Formato de tiempo: hh:mm:ss.d (décima) */
function formatTimeWithTenths(t){
  if(t == null || !isFinite(t)) return "";
  const total = Math.max(0, t);
  const hours = Math.floor(total / 3600);
  const minutes = Math.floor((total % 3600) / 60);
  const seconds = Math.floor(total % 60);
  const tenths = Math.floor((total - Math.floor(total)) * 10);
  return String(hours).padStart(2,"0") + ":" +
         String(minutes).padStart(2,"0") + ":" +
         String(seconds).padStart(2,"0") + "." +
         tenths;
}

/* Abrir archivo: activo mientras está el diálogo */
openBtn.onclick = ()=>{
  pulse(openBtn);
  openBtn.classList.add("active");
  file.click();
};

zoomBtn.onclick = ()=>{
  pulse(zoomBtn);
  // ciclo de zoom: 1 -> 1.25 -> 1.5 -> 2 -> 1 ...
  const levels = [1, 1.25, 1.5, 2];
  const currentIndex = levels.findIndex(v => Math.abs(v - zoomLevel) < 0.001);
  const nextIndex = (currentIndex + 1) % levels.length;
  zoomLevel = levels[nextIndex];
  updateZoomUI();
};
file.onchange = e=>{
  openBtn.classList.remove("active");
  const f = e.target.files[0];
  if(f){
    currentFile = f;
    if(fileNameLabel){
      fileNameLabel.textContent = currentFile.name || "(archivo local)";
    }
    vid.src = URL.createObjectURL(f);
    vid.play();
    setTimeout(updateInfoMeta,200);
  }
};

// Info toggle
infoBtn.onclick=()=>{
  pulse(infoBtn);
  if(infoPanel.style.display==="block"){
    infoPanel.style.display="none";
    infoBtn.classList.remove("active");
  }else{
    updateInfoMeta();
    infoPanel.style.display="block";
    infoBtn.classList.add("active");
  }
};

function human(n){
  if(n<1024) return n+" B";
  if(n<1024**2) return (n/1024).toFixed(1)+" KB";
  if(n<1024**3) return (n/1024**2).toFixed(1)+" MB";
  return (n/1024**3).toFixed(2)+" GB";
}
function updateInfoMeta(){
  const lines=[];
  if(currentFile){
    lines.push("Nombre: "+(currentFile.name||"(desconocido)"));
    lines.push("Tamaño: "+human(currentFile.size||0));
    if(currentFile.lastModified) lines.push("Modificado: "+new Date(currentFile.lastModified).toLocaleString());
  }else{
    lines.push("Nombre: —");
    lines.push("Tamaño: —");
    lines.push("Modificado: —");
  }
  if(vid.videoWidth && vid.videoHeight){
    lines.push("Resolución: "+vid.videoWidth+"×"+vid.videoHeight);
  }else{
    lines.push("Resolución: —");
  }
  if(vid.duration && isFinite(vid.duration)){
    const d=Math.floor(vid.duration);
    const mm=String(Math.floor(d/60)).padStart(2,"0");
    const ss=String(d%60).padStart(2,"0");
    lines.push("Duración: "+mm+":"+ss);
  }else{
    lines.push("Duración: —");
  }
  infoMeta.textContent = lines.join("\n");

  const about=[
    "CursoPlayerWeb",
    "© 2025 Francisco Javier Falcón Muñoz",
    "",
    "Función: Herramienta didáctica para analizar vídeos de baile con:",
    "• Reproducción con control de velocidad",
    "• Marcas A y B y bucle A-B",
    "• Barra de tiempo precisa con arrastre",
    "• Espejo (flip horizontal)",
    "• Pantalla completa",
    "• Control de volumen"
  ].join("\n");
  aboutMeta.textContent = about;
}

// Play / pausa + estado activo
playBtn.onclick=()=>{
  pulse(playBtn);
  if(vid.paused){vid.play();}
  else{vid.pause();}
};
vid.addEventListener("play",()=>{
  playShape.setAttribute("d","M7 5h4v14H7zM13 5h4v14h-4z");
  playBtn.classList.add("active");
});
vid.addEventListener("pause",()=>{
  playShape.setAttribute("d","M8 5v14l11-7z");
  playBtn.classList.remove("active");
});

// Pantalla completa + estado activo
fsBtn.onclick=()=>{
  pulse(fsBtn);
  toggleFS();
};
document.addEventListener("fullscreenchange",()=>{
  fsBtn.classList.toggle("active", !!document.fullscreenElement);
});

// Espejo
mirrorBtn.onclick=()=>{
  isMirrored = !isMirrored;
  mirrorBtn.classList.toggle("active", isMirrored);
  pulse(mirrorBtn);
  applyVideoTransform();
};

// Velocidad
document.querySelector("#speedDown").onclick=()=>{
  pulse(speedDownBtn);
  rate = Math.max(.1, +(rate-.1).toFixed(2));
  vid.playbackRate = rate;
  updateRateUI();
};
document.querySelector("#speedUp").onclick=()=>{
  pulse(speedUpBtn);
  rate = Math.min(3, +(rate+.1).toFixed(2));
  vid.playbackRate = rate;
  updateRateUI();
};
rateLabel.onclick=()=>{
  pulse(rateLabel);
  rate = 1;
  vid.playbackRate = 1;
  updateRateUI();
};

// Marcas A y B automáticas via botón de bucle
clearABBtn.onclick=()=>{
  A=null;B=null;
  loopAB=false;
  abRange.classList.remove("loop-active");
  pulse(clearABBtn);
  updateMarks();
  updateLoopBtnState();
  updateProgressUI();
};
loopBtn.onclick=()=>{
  // Si las marcas ya están establecidas, no hacer nada
  if(A != null && B != null){
    return;
  }
  if(vid.duration && isFinite(vid.duration)){
    A = vid.duration * 0.33;
    B = vid.duration * 0.66;
    vid.currentTime = A;
  }
  loopAB = true;
  abRange.classList.add("loop-active");
  pulse(loopBtn);
  updateMarks();
  updateLoopBtnState();
  updateProgressUI();
};

// Volumen
volumeBtn.onclick=(e)=>{
  pulse(volumeBtn);
  e.stopPropagation();
  const isOpen = volPop.style.display==="flex";
  volPop.style.display = isOpen ? "none" : "flex";
};
volRange.addEventListener("input",(e)=>{
  vid.volume = +e.target.value;
  updateVolumeUI();
});
volRange.addEventListener("pointerdown",(e)=>{
  const rect = volRange.getBoundingClientRect();
  let x = Math.max(rect.left, Math.min(e.clientX, rect.right));
  const ratio = (x - rect.left) / rect.width;
  const min = parseFloat(volRange.min);
  const max = parseFloat(volRange.max);
  let val = min + ratio * (max - min);
  if(val < min) val = min;
  if(val > max) val = max;
  volRange.value = val;
  vid.volume = val;
  updateVolumeUI();
});
document.addEventListener("click",(e)=>{
  if(!volumeBtn.contains(e.target)) volPop.style.display="none";
});

volPop.addEventListener("wheel",(e)=>{
  e.preventDefault();
  const step = 0.05;
  let v = vid.volume;
  if(e.deltaY < 0) v += step;
  else if(e.deltaY > 0) v -= step;
  if(v < 0) v = 0;
  if(v > 1) v = 1;
  vid.volume = v;
  volRange.value = v;
  updateVolumeUI();
},{passive:false});

function seekRelative(delta){
  if(!(vid.duration && isFinite(vid.duration))) return;
  let t = vid.currentTime + delta;
  if(t < 0) t = 0;
  if(vid.duration && isFinite(vid.duration) && t > vid.duration) t = vid.duration;

  // Si el bucle A-B está activo y salimos del rango, volvemos a A
  if(loopAB && A!=null && B!=null){
    const a = Math.min(A,B);
    const b = Math.max(A,B);
    if(t < a || t > b){
      t = A;
    }
  }

  vid.currentTime = t;
  updateProgressUI();
}

function toggleFS(){
  if(!document.fullscreenElement) document.documentElement.requestFullscreen();
  else document.exitFullscreen();
}

function pct(){
  if(!vid.duration || !isFinite(vid.duration)) return 0;
  return Math.max(0,Math.min(1, vid.currentTime/vid.duration));
}
function timeToPct(t){
  if(!vid.duration || !isFinite(vid.duration)) return 0;
  const frac=Math.max(0,Math.min(1,t/vid.duration));
  return frac*100;
}
function pctToTime(p){
  if(!vid.duration || !isFinite(vid.duration)) return 0;
  const frac=Math.max(0,Math.min(1,p/100));
  return frac*vid.duration;
}

function updateMarks(){
  // Posición visual
  if(A!=null){
    markAEl.style.left = timeToPct(A)+"%";
    markAEl.classList.add("show");
    const labelA = formatTimeWithTenths(A);
    markALabel.textContent = labelA || "";
  }else{
    markAEl.classList.remove("show");
    markALabel.textContent = "";
  }

  if(B!=null){
    markBEl.style.left = timeToPct(B)+"%";
    markBEl.classList.add("show");
    const labelB = formatTimeWithTenths(B);
    markBLabel.textContent = labelB || "";
  }else{
    markBEl.classList.remove("show");
    markBLabel.textContent = "";
  }

  // Rango A-B
  if(A!=null && B!=null){
    const a=Math.min(A,B), b=Math.max(A,B);
    const left=timeToPct(a), right=timeToPct(b);
    abRange.style.left = left+"%";
    abRange.style.width = (right-left)+"%";
    abRange.classList.add("show");
  }else{
    abRange.classList.remove("show");
  }
  updateLoopBtnState();
}

function updateProgressUI(){
  const p = pct()*100;
  trail.style.width = p+"%";
  dot.style.left = p+"%";
  updateMarks();
  updateTimeLabels();
}

vid.addEventListener("timeupdate",()=>{
  if(loopAB && A!=null && B!=null && B>A){
    if(vid.currentTime>=B) vid.currentTime=A;
  }
  updateProgressUI();
});
function maybeGenerateBackground(){
  if(!(vid.videoWidth && vid.videoHeight && vid.duration && isFinite(vid.duration))) return;
  const videoRatio = vid.videoWidth / vid.videoHeight;
  const windowRatio = window.innerWidth / window.innerHeight;
  const hasBars = Math.abs(videoRatio - windowRatio) > 0.05;
  if(!hasBars) return;

  const canvas = document.createElement("canvas");
  canvas.width = vid.videoWidth;
  canvas.height = vid.videoHeight;
  const ctx = canvas.getContext("2d");

  const originalTime = vid.currentTime;
  const wasPaused = vid.paused;

  function onSeeked(){
    try{
      ctx.drawImage(vid, 0, 0, canvas.width, canvas.height);
      const url = canvas.toDataURL("image/jpeg", 0.9);
      bgFrame.style.backgroundImage = `url(${url})`;
      bgFrame.style.opacity = "1";
    }catch(err){
      console.error("No se pudo generar fondo difuminado:", err);
    }finally{
      vid.removeEventListener("seeked", onSeeked);
      vid.currentTime = originalTime;
      if(!wasPaused) vid.play();
    }
  }

  vid.addEventListener("seeked", onSeeked);
  vid.pause();
  vid.currentTime = vid.duration / 2;
}

vid.addEventListener("loadedmetadata",()=>{
  rate = 1;
  vid.playbackRate = 1;
  updateRateUI();
  updateProgressUI();
  updateTimeLabels();
  maybeGenerateBackground();
});
window.addEventListener("resize",updateProgressUI);

/* Seek por clic y arrastre */
function setTimeFromClientX(clientX){
  const r = inner.getBoundingClientRect();
  let x = Math.max(r.left,Math.min(clientX,r.right));
  const frac = (x-r.left)/r.width;
  if(!(vid.duration && isFinite(vid.duration))){
    return;
  }
  const candidate = frac * vid.duration;

  if(loopAB && A!=null && B!=null){
    const a = Math.min(A,B);
    const b = Math.max(A,B);
    // Si el clic está fuera de A-B, se ignora
    if(candidate < a || candidate > b){
      return;
    }
  }

  vid.currentTime = candidate;
  updateProgressUI();
}
seek.addEventListener("pointerdown",(e)=>{
  isSeeking=true;
  seek.setPointerCapture(e.pointerId);
  setTimeFromClientX(e.clientX);
});
seek.addEventListener("pointermove",(e)=>{
  if(isSeeking) setTimeFromClientX(e.clientX);
});
seek.addEventListener("pointerup",(e)=>{
  isSeeking=false;
  seek.releasePointerCapture(e.pointerId);
});
seek.addEventListener("pointercancel",()=>{isSeeking=false;});

/* Arrastre de marcas A y B con zona de marcación */
function onMarkPointerDown(e,which){
  if(!(vid.duration && isFinite(vid.duration))) return;
  e.stopPropagation();
  e.preventDefault();
  draggingMark = which;
  e.currentTarget.setPointerCapture(e.pointerId);
}
function onMarkPointerMove(e){
  if(!draggingMark) return;
  const r = inner.getBoundingClientRect();
  let x = Math.max(r.left,Math.min(e.clientX,r.right));
  const p = ((x-r.left)/r.width)*100;
  let t = pctToTime(p);

  if(!(vid.duration && isFinite(vid.duration))) return;
  // Aseguramos que el tiempo esté dentro del rango del vídeo
  if(t < 0) t = 0;
  if(t > vid.duration) t = vid.duration;

  if(draggingMark==="A"){
    // A nunca puede superar a B - MIN_AB_GAP
    if(B != null){
      const maxA = B - MIN_AB_GAP;
      if(t > maxA) t = Math.max(0, maxA);
    }
    A = t;
  }
  if(draggingMark==="B"){
    // B nunca puede ser inferior a A + MIN_AB_GAP
    if(A != null){
      const minB = A + MIN_AB_GAP;
      if(t < minB) t = Math.min(vid.duration, minB);
    }
    B = t;
  }
  updateMarks();
}
function onMarkPointerUp(e){
  if(!draggingMark) return;
  e.currentTarget.releasePointerCapture(e.pointerId);
  draggingMark=null;
  if(loopAB && A!=null && B!=null){
    const a = Math.min(A,B);
    const b = Math.max(A,B);
    if(vid.currentTime < a || vid.currentTime > b){
      vid.currentTime = A;
      updateProgressUI();
    }
  }
}
["pointerdown"].forEach(ev=>{
  markAEl.addEventListener(ev,(e)=>onMarkPointerDown(e,"A"));
  markBEl.addEventListener(ev,(e)=>onMarkPointerDown(e,"B"));
});
["pointermove"].forEach(ev=>{
  markAEl.addEventListener(ev,onMarkPointerMove);
  markBEl.addEventListener(ev,onMarkPointerMove);
});
["pointerup","pointercancel"].forEach(ev=>{
  markAEl.addEventListener(ev,onMarkPointerUp);
  markBEl.addEventListener(ev,onMarkPointerUp);
});

// Inicializar estados
rate = 1;
vid.playbackRate = 1;
volRange.value = vid.volume;
updateRateUI();
updateVolumeUI();
updateInfoMeta();
updateProgressUI();
</script>

</body>
</html>
